<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Permit Statistics Table</title>
  <style>
    :root {
      --bg: #0f172a;          /* page background: dark slate */
      --card-bg: #0b1120;     /* card background: deep navy */
      --accent: #38bdf8;      /* cyan accent */
      --accent-soft: rgba(56, 189, 248, 0.12);
      --accent-strong: #0ea5e9;
      --text-main: #e5e7eb;   /* light gray text */
      --text-muted: #9ca3af;  /* muted gray text */
      --border-subtle: rgba(148, 163, 184, 0.35);
      --danger: #f97373;
      --radius-lg: 16px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.7);
    }
    
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 32px 16px;
    }
    
    /* Overall layout container */
    .main-wrapper {
        margin-left: auto;
        margin-right: auto;
        max-width: 900px;
    }
    
    /* Header */
    h1 {
      margin: 0 0 4px 0;
      font-size: 1.9rem;
      text-align: center;
      letter-spacing: 0.03em;
    }
    
    .subtitle {
      margin: 0 0 24px 0;
      font-size: 0.95rem;
      color: var(--text-muted);
      text-align: center;
    }
    
    /* Cards */
    .card {
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.09), transparent 50%),
                  var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 20px 20px 18px 20px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(15, 23, 42, 0.9);
      margin-bottom: 20px;
    }
    
    /* Form layout */
    #stats-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .choice-title {
      margin-top: 10px;
      font-size: 0.9rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--accent);
    }
    
    .choice-row {
      display: grid;
      grid-template-columns: 1.3fr 1.3fr 0.8fr;
      gap: 10px;
      margin-top: 4px;
    }
    
    label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
    }
    
    /* Inputs & selects */
    input[type="date"],
    input[type="number"],
    select {
      width: 100%;
      margin-top: 4px;
      padding: 8px 10px;
      border-radius: 9px;
      border: 1px solid var(--border-subtle);
      background-color: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
    }
    
    input[type="date"]::placeholder,
    input[type="number"]::placeholder {
      color: var(--text-muted);
    }
    
    input[type="date"]:focus,
    input[type="number"]:focus,
    select:focus {
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px var(--accent), 0 0 0 6px rgba(56, 189, 248, 0.12);
      background-color: #020617;
    }
    
    /* Button */
    button[type="submit"] {
      align-self: flex-start;
      margin-top: 14px;
      padding: 10px 20px;
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #0b1120;
      box-shadow: 0 14px 30px rgba(56, 189, 248, 0.35);
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
    }
    
    button[type="submit"]:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 20px 40px rgba(56, 189, 248, 0.45);
      filter: brightness(1.05);
    }
    
    button[type="submit"]:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 10px 20px rgba(56, 189, 248, 0.25);
    }
    
    button[type="submit"]:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    
    /* Error text */
    #error {
      color: var(--danger);
      margin-top: 8px;
      font-size: 0.8rem;
    }
    
    /* Results card */
    .card h2 {
      margin: 0 0 8px 0;
      font-size: 1.1rem;
    }
    
    #table-container {
      margin-top: 6px;
      overflow-x: auto;
    }
    
    /* Table styling */
    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border-subtle);
    }
    
    th,
    td {
      padding: 8px 10px;
      font-size: 0.86rem;
      text-align: center;
      border-bottom: 1px solid rgba(51, 65, 85, 0.9);
    }
    
    th:first-child,
    td:first-child {
      text-align: left;
    }
    
    th {
      background: linear-gradient(to bottom, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 1));
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }
    
    tbody tr:nth-child(odd):not(.totals-row) {
      background-color: rgba(15, 23, 42, 0.7);
    }
    
    tbody tr:nth-child(even):not(.totals-row) {
      background-color: rgba(15, 23, 42, 0.95);
    }
    
    tbody tr:hover:not(.totals-row) {
      background-color: rgba(30, 64, 175, 0.35);
    }
    
    /* Totals row styling */
    .totals-row {
      background: var(--accent-soft);
    }
    
    .totals-row td {
      font-weight: 600;
    }
    
    .totals-row td:first-child {
      color: var(--accent-strong);
    }
    
    /* “Comparable date” line in each cell is already a smaller span inline */
    
    /* “No data” cell */
    .no-data {
      color: var(--text-muted);
      font-style: italic;
    }
    
    /* Responsive tweaks */
    @media (max-width: 720px) {
      body {
        padding: 20px 12px;
      }
    
      .card {
        padding: 16px 14px;
      }
    
      .choice-row {
        grid-template-columns: 1fr;
      }
    
      h1 {
        font-size: 1.5rem;
      }

      .card.results-card {
        text-align: center;
      }
      
      .card.results-card table {
        margin-left: auto;
        margin-right: auto;
      }
    }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <div class="card">
      <h1>Permit Statistics (Table View)</h1>
      <p class="subtitle">
        Enter up to <strong>three</strong> choices. Each choice has its own zone, date, and group size.
        The table will show estimated odds for each choice across the years <strong>2020–2024</strong>,
        along with the comparable date used in each year.
      </p>

      <form id="stats-form">
        <!-- Choice 1 -->
        <div class="choice-title">Choice 1</div>
        <div class="choice-row">
          <div>
            <label>Zone 1:
              <select id="zone1">
                <option value="">-- Select zone --</option>
                <option value="Core">Core</option>
                <option value="Colchuck">Colchuck</option>
                <option value="Snow">Snow</option>
                <option value="Eightmile">Eightmile</option>
                <option value="Stuart">Stuart</option>
                <option value="None">None</option>
              </select>
            </label>
          </div>
          <div>
            <label>Date 1:
              <input type="date" id="date1" min="2026-05-15" max="2026-10-31" />
            </label>
          </div>
          <div>
            <label>Group Size 1:
              <select id="group_size1">
                <option value="">--</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
              </select>
            </label>
          </div>
        </div>

        <!-- Choice 2 -->
        <div class="choice-title">Choice 2</div>
        <div class="choice-row">
          <div>
            <label>Zone 2:
              <select id="zone2">
                <option value="">-- Select zone --</option>
                <option value="Core">Core</option>
                <option value="Colchuck">Colchuck</option>
                <option value="Snow">Snow</option>
                <option value="Eightmile">Eightmile</option>
                <option value="Stuart">Stuart</option>
                <option value="None">None</option>
              </select>
            </label>
          </div>
          <div>
            <label>Date 2:
              <input type="date" id="date2" min="2026-05-15" max="2026-10-31" />
            </label>
          </div>
          <div>
            <label>Group Size 2:
              <select id="group_size2">
                <option value="">--</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
              </select>
            </label>
          </div>
        </div>

        <!-- Choice 3 -->
        <div class="choice-title">Choice 3</div>
        <div class="choice-row">
          <div>
            <label>Zone 3:
              <select id="zone3">
                <option value="">-- Select zone --</option>
                <option value="Core">Core</option>
                <option value="Colchuck">Colchuck</option>
                <option value="Snow">Snow</option>
                <option value="Eightmile">Eightmile</option>
                <option value="Stuart">Stuart</option>
                <option value="None">None</option>
              </select>
            </label>
          </div>
          <div>
            <label>Date 3:
              <input type="date" id="date3" min="2026-05-15" max="2026-10-31" />
            </label>
          </div>
          <div>
            <label>Group Size 3:
              <select id="group_size3">
                <option value="">--</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
              </select>
            </label>
          </div>
        </div>

        <button type="submit" id="submit-button">Get Table</button>
        <div id="error"></div>
      </form>

      <h2 style="margin-top: 22px;">Results</h2>
      <div id="table-container">
        <!-- Table will be inserted here -->
      </div>
    </div> <!-- end .card -->
  </div> <!-- end .main-wrapper -->

  <script>
    const API_BASE_URL = '';

    // Convert "YYYY-MM-DD" (from the form) to "Mmm dd"
    function formatIsoDateToMmmDd(isoDate) {
      if (!isoDate) return '';
      const [yearStr, monthStr, dayStr] = isoDate.split('-');
      const month = parseInt(monthStr, 10);
      const day = parseInt(dayStr, 10);
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                      'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return months[month - 1] + ' ' + day.toString();
    }

    // Convert "MM-DD-YYYY" (from backend comparable date) to "Mmm dd"
    function formatMmDdYyyyToMmmDd(mdY) {
      if (!mdY) return '';
      const [monthStr, dayStr, yearStr] = mdY.split('-');
      const month = parseInt(monthStr, 10);
      const day = parseInt(dayStr, 10);
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                      'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return months[month - 1] + ' ' + day.toString();
    }

    const form = document.getElementById('stats-form');
    const errorDiv = document.getElementById('error');
    const tableContainer = document.getElementById('table-container');
    const submitButton = document.getElementById('submit-button');

    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      errorDiv.textContent = '';
      tableContainer.innerHTML = 'Building table...';

      // Collect all choices from the form
      const choices = [
        {
          label: 'Choice 1',
          zone: document.getElementById('zone1').value.trim(),
          date: document.getElementById('date1').value,
          groupSizeValue: document.getElementById('group_size1').value
        },
        {
          label: 'Choice 2',
          zone: document.getElementById('zone2').value.trim(),
          date: document.getElementById('date2').value,
          groupSizeValue: document.getElementById('group_size2').value
        },
        {
          label: 'Choice 3',
          zone: document.getElementById('zone3').value.trim(),
          date: document.getElementById('date3').value,
          groupSizeValue: document.getElementById('group_size3').value
        }
      ];

      // Keep only rows where zone AND date are filled
      const filledChoices = choices.filter(
        (c) => c.zone !== '' && c.date !== ''
      );

      if (filledChoices.length === 0) {
        errorDiv.textContent = 'Please fill in at least one zone/date choice with a group size.';
        tableContainer.innerHTML = '';
        return;
      }

      // Extra safety: ensure dates are within the allowed lottery window
      const minDate = new Date('2026-05-15');
      const maxDate = new Date('2026-10-31');
      
      for (const c of filledChoices) {
        const d = new Date(c.date);
        if (isNaN(d.getTime()) || d < minDate || d > maxDate) {
          errorDiv.textContent = 'Dates must be between May 15 and Oct 31, 2026.';
          tableContainer.innerHTML = '';
          return;
        }
      }


      // Validate group size for each filled choice
      for (const c of filledChoices) {
        const size = parseInt(c.groupSizeValue, 10);
        if (!c.groupSizeValue || isNaN(size) || size < 1) {
          errorDiv.textContent = `Please enter a valid group size (at least 1) for ${c.label}.`;
          tableContainer.innerHTML = '';
          return;
        }
        c.groupSize = size;
      }

      // Use the year from the first filled choice's date as the permit year
      const [permitYearStr] = filledChoices[0].date.split('-');
      const permitYear = parseInt(permitYearStr, 10);

      // Historical years used by your databases
      const dataYears = [2020, 2021, 2022, 2023, 2024];

      // Prepare payload choices (only filled ones)
      const apiChoices = filledChoices.map((c) => {
        const [yearStr, monthStr, dayStr] = c.date.split('-');
        return {
          zone: c.zone,
          month: parseInt(monthStr, 10),
          day: parseInt(dayStr, 10),
          group_size: c.groupSize
        };
      });

      submitButton.disabled = true;
      submitButton.textContent = 'Loading...';

      try {
        const response = await fetch(API_BASE_URL + '/estimate_odds', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            permit_year: permitYear,
            data_years: dataYears,
            choices: apiChoices
          })
        });

        if (!response.ok) {
          errorDiv.textContent = 'Error from server: ' + response.status + ' ' + response.statusText;
          tableContainer.innerHTML = '';
          return;
        }

        const data = await response.json();

        const years = data.years || [];
        const resultChoices = data.choices || [];

        // Build table
        const table = document.createElement('table');

        // Header row
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const firstHeader = document.createElement('th');
        firstHeader.textContent = 'Zone / Date / Group Size';
        headerRow.appendChild(firstHeader);

        years.forEach((year) => {
          const th = document.createElement('th');
          th.textContent = year.toString();
          headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');

        // For each filled choice, add a row
        filledChoices.forEach((c, index) => {
          const backendChoice = resultChoices[index];

          const row = document.createElement('tr');

          const labelCell = document.createElement('td');
          const prettyPermitDate = formatIsoDateToMmmDd(c.date);
          labelCell.textContent =
            `${c.label}: ${c.zone} (${prettyPermitDate}), ${c.groupSize} people`;
          row.appendChild(labelCell);

          years.forEach((year) => {
            const cell = document.createElement('td');

            if (!backendChoice) {
              cell.textContent = 'N/A';
              cell.className = 'no-data';
              row.appendChild(cell);
              return;
            }

            const oddsByYear = backendChoice.odds_by_year || {};
            const compDatesByYear = backendChoice.comp_dates_by_year || {};

            const value = oddsByYear[year];
            const compDate = compDatesByYear[year];

            if (value === null || value === undefined) {
              cell.textContent = '';
            } else {
              const prettyCompDate = compDate ? formatMmDdYyyyToMmmDd(compDate) : '';

              if (prettyCompDate) {
                cell.innerHTML =
                  (value * 100).toFixed(1) + '%' +
                  '<br><span style="font-size: 0.9em; color: #666;">' +
                  prettyCompDate +
                  '</span>';
              } else {
                cell.textContent = (value * 100).toFixed(1) + '%';
              }
            }

            row.appendChild(cell);
          });

          tbody.appendChild(row);
        });

        // Add a totals row: sum of odds across all choices for each year
        const totalsRow = document.createElement('tr');

        totalsRow.classList.add('totals-row');
        
        // Label cell
        const totalsLabelCell = document.createElement('td');
        totalsLabelCell.textContent = 'Total odds of winning any choice';
        totalsLabelCell.style.fontWeight = 'bold';
        totalsRow.appendChild(totalsLabelCell);
        
        // One cell per year with the summed odds
        years.forEach((year) => {
          let total = 0;
        
          // Sum odds across all filled choices for this year
          filledChoices.forEach((c, index) => {
            const backendChoice = resultChoices[index];
            if (!backendChoice) return;
        
            const oddsByYear = backendChoice.odds_by_year || {};
            const value = oddsByYear[year];
        
            if (value !== null && value !== undefined) {
              total += value;
            }
          });
        
          const cell = document.createElement('td');
          cell.textContent = (total * 100).toFixed(1) + '%';
          cell.style.fontWeight = 'bold';
          totalsRow.appendChild(cell);
        });
        
        tbody.appendChild(totalsRow);

        table.appendChild(tbody);
        tableContainer.innerHTML = '';
        tableContainer.appendChild(table);

      } catch (err) {
        console.error(err);
        errorDiv.textContent = 'Something went wrong while contacting the server.';
        tableContainer.innerHTML = '';
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Get Table';
      }
    });
  </script>
</body>
</html>











